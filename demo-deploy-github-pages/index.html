<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.50.0/dist/phaser.js"></script>
    <style type="text/css">
      /* body {
        border: "1px solid #ddd";
      } */
    </style>
  </head>
  <body>
    <script type="text/javascript">
      const phaserConfig = {
        type: Phaser.AUTO,
        parent: "game",
        backgroundColor: "#f8f8f8",
        width: window.innerWidth < 450 ? window.innerWidth : 1000,
        height: 340,
        scale: {
          autoCenter: Phaser.Scale.CENTER_BOTH,
        },
        scene: {
          init: initScene,
          preload: preloadScene,
          create: createScene,
          update: updateScene,
        },
        physics: {
          default: "arcade",
          arcade: {
            gravity: { y: 300 },
            debug: false,
          },
        },
      };

      var game = new Phaser.Game(phaserConfig);

      var ground,
        groundsScrollTop,
        groundsScrollBottom,
        player,
        cursors,
        gameOverText,
        scoreText,
        reload,
        startText,
        boy,
        laneDisplayTop,
        laneDisplayBottom;
      var gameOver = false;
      var isStart = false;
      var prevTime = null;
      var speed = 7;
      var score = 0;
      var count = 0;
      var width = game.config.width;
      var height = game.config.height;
      var topHeight = 330;
      var middleHeight = 230;
      var bottomHeight = 130;
      var prevHeight = middleHeight;

      function initScene() {}
      function preloadScene() {
        this.load.image("ground", "assets/ground.png");
        this.load.image("tree1", "assets/tree1.png");
        this.load.image("tree2", "assets/tree2.png");
        this.load.image("tree3", "assets/tree3.png");
        this.load.image("gameOverText", "assets/gameover.png");
        this.load.image("start", "assets/start.png");
        this.load.image("google", "assets/googleChrome.png");
        this.load.image("reload", "assets/reload.png");
        this.load.image("boy", "assets/win-boy.png");
        this.load.spritesheet("thin", "assets/thin-boy.png", {
          frameWidth: 52,
          frameHeight: 70,
        });
        this.load.spritesheet("normal", "assets/normal-boy.png", {
          frameWidth: 52,
          frameHeight: 70,
        });
        this.load.spritesheet("fat", "assets/fat-boy.png", {
          frameWidth: 52,
          frameHeight: 70,
        });
      }
      function createScene() {
        // khai báo tileSprite để nền đất auto scroll ngang màn hình
        groundsScrollTop = this.add
          .tileSprite(0, 20, width, 20, "ground") // tọa độ x,y khi xuất hiện, width, height của đối tượng, tên đối tượng
          .setOrigin(0, 0);

        groundsScrollBottom = this.add
          .tileSprite(width, height - 20, width, 20, "ground") // tọa độ x,y khi xuất hiện, width, height của đối tượng, tên đối tượng
          .setOrigin(0, 0)
          .setAngle(-180);

        player = this.physics.add
          .sprite(100, 180, "fat")
          .setOrigin(0, 0) // tọa độ x, y tính từ góc trên cùng bên trái màn hình
          .setCollideWorldBounds(true, 0, 0) // va chạm với body, tọa độ x, y (chưa hiểu lắm)
          .setGravityY(5000); // trọng lực, số càng cao -> nhân vật lúc xuất hiện rơi xuống càng nhanh

        player.body.height = middleHeight;
        player.alpha = 0;

        this.anims.create({
          key: "run",
          frames: this.anims.generateFrameNumbers("thin", {
            start: 0, // dinosaur là 1 sprite gồm nhiều hình, start 0, end 1 -> lấy từ hình thứ nhất đến hình thứ 2
            end: 5,
          }),
          frameRate: 18, // 10 hình trong 1s
          repeat: -1, // không lặp lại
        });

        startText = this.add
          .image(
            width / 2, // tọa độ x khi xuất hiện
            100, // tọa độ y khi xuất hiện
            "start" // đối tượng xuất hiện
          )
          .setScale(0.2);

        boy = this.add.image(
          width / 2, // tọa độ x khi xuất hiện
          190, // tọa độ y khi xuất hiện
          "boy" // đối tượng xuất hiện
        );

        laneDisplayTop = this.add
          .grid(0, 120, width * 1000, 5, 50, 5, 0xbfbfbf)
          .setAltFillStyle(0xf8f8f8)
          .setOutlineStyle()
          .setDepth(-1);

        laneDisplayBottom = this.add
          .grid(10, 220, width * 1000, 5, 50, 5, 0xbfbfbf)
          .setAltFillStyle(0xf8f8f8)
          .setOutlineStyle()
          .setDepth(-1);

        laneDisplayTop.alpha = 0;
        laneDisplayBottom.alpha = 0;

        cursors = this.input.keyboard.createCursorKeys();
        input = this.input.activePointer.isDown;
      }

      function isDownFunction() {
        if (player.body.height === topHeight) {
          player.body.height = middleHeight;
          prevHeight = topHeight;
        }

        if (
          player.body.height === middleHeight &&
          prevHeight === middleHeight
        ) {
          player.body.height = bottomHeight;
          prevHeight = middleHeight;
        }
      }

      function isUpFunction() {
        if (player.body.height === bottomHeight) {
          player.body.height = middleHeight;
          prevHeight = bottomHeight;
        }

        if (
          player.body.height === middleHeight &&
          prevHeight === middleHeight
        ) {
          player.body.height = topHeight;
          prevHeight = middleHeight;
        }
      }

      function updateScene(time, delta) {
        if (gameOver) {
          return;
        }

        if (isStart) {
          groundsScrollTop.tilePositionX += speed;
          groundsScrollBottom.tilePositionX -= speed;

          laneDisplayTop.setAlpha(1);
          laneDisplayBottom.setAlpha(1);

          this.tweens.add({
            targets: laneDisplayTop,
            x: `-=${speed * 60}`,
            ease: "Sine.stepped",
          });

          this.tweens.add({
            targets: laneDisplayBottom,
            x: `-=${speed * 60}`,
            ease: "Sine.stepped",
          });

          player.alpha = 1;
          player.anims.play("run", 1);

          startText.alpha = 0;
          boy.alpha = 0;
        }

        if (cursors.space.isDown) {
          isStart = true;
        } else {
          if (cursors.down.isDown) {
            isDownFunction();
          } else {
            if (cursors.up.isDown) {
              isUpFunction();
            }
          }
        }

        if (
          cursors.down.isUp &&
          cursors.up.isUp &&
          player.body.height === middleHeight
        ) {
          prevHeight = middleHeight;
        }
      }
    </script>
  </body>
</html>
